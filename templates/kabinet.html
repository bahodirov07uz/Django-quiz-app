{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'kabinet.css' %}">
</head>

<body>
    <header class="header">
        <nav class="navbar">
            <a href="/" class="nav-btn home-link" title="Home">
                <span class="nav-icon">
                    <!-- Home SVG -->
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                        <path
                            d="M3 11L12 3L21 11V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V11Z"
                            stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M9 22V12H15V22" stroke="#fff" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </span>
                <span class="nav-text">Home</span>
            </a>
            <span class="score-badge" title="Your score">
                <span class="score-icon">
                    <!-- Star SVG -->
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path
                            d="M12 17L5.87868 20.7639C5.31946 21.0861 4.68426 20.6138 4.80902 19.9871L6.26439 12.5592L1.23607 7.23607C0.799035 6.80812 1.02362 6.04806 1.64195 5.97331L9.12202 5.0918L12 0.5L14.878 5.0918L22.3581 5.97331C22.9764 6.04806 23.201 6.80812 22.7639 7.23607L17.7356 12.5592L19.191 19.9871C19.3157 20.6138 18.6805 21.0861 18.1213 20.7639L12 17Z"
                            stroke="#9effd0" stroke-width="1.5" fill="none" />
                    </svg>
                </span>
                <span class="score-num">{{ user.score }}</span>
            </span>
            <a href="#" class="nav-btn reyting-link" id="open-reyting-modal">
                <span class="nav-icon">
                    <!-- Trophy SVG -->
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                        <path d="M7 17v2a3 3 0 003 3h4a3 3 0 003-3v-2" stroke="#ffd700" stroke-width="2" fill="none" />
                        <path d="M4 6V4a1 1 0 011-1h14a1 1 0 011 1v2a5 5 0 01-5 5H9A5 5 0 014 6z" stroke="#ffd700"
                            stroke-width="2" fill="none" />
                        <circle cx="12" cy="13" r="2" stroke="#ffd700" stroke-width="2" fill="none" />
                    </svg>
                </span>
                <span class="nav-text">Top Ranking</span>
            </a>
            <a href="#" id="profile-btn" class="nav-btn kabinet-link">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="8" r="4" stroke="#fff" stroke-width="2" />
                    <path d="M2 21C2 17.134 6.477 14 12 14C17.523 14 22 17.134 22 21" stroke="#fff" stroke-width="2" />
                </svg>
                <span class="nav-text">Profile</span>
            </a>

        </nav>
    </header>
    <!-- Profile dropdown/modal -->
    <div id="profile-dropdown" class="profile-dropdown">
        <div class="profile-content">
            <!-- User Score -->
            <div class="score-section">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path
                        d="M12 17L5.87868 20.7639C5.31946 21.0861 4.68426 20.6138 4.80902 19.9871L6.26439 12.5592L1.23607 7.23607C0.799035 6.80812 1.02362 6.04806 1.64195 5.97331L9.12202 5.0918L12 0.5L14.878 5.0918L22.3581 5.97331C22.9764 6.04806 23.201 6.80812 22.7639 7.23607L17.7356 12.5592L19.191 19.9871C19.3157 20.6138 18.6805 21.0861 18.1213 20.7639L12 17Z"
                        stroke="#9effd0" stroke-width="1.5" fill="none" />
                </svg>
                <span class="score-num">{{ user.score }}</span>
            </div>
            <hr />
            <!-- Menu items -->
            <a href="/kabinet/" class="dropdown-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="8" r="4" stroke="#fff" stroke-width="2" />
                    <path d="M2 21C2 17.134 6.477 14 12 14C17.523 14 22 17.134 22 21" stroke="#fff" stroke-width="2" />
                </svg>
                <span>Profile</span>
            </a>
            <a href="{% url 'accounts:settings' %}" class="dropdown-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="3" stroke="#fff" stroke-width="2" />
                    <path
                        d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06A1.65 1.65 0 0015 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 008.6 15a1.65 1.65 0 00-1.82-.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.6a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0015 8.6c.26 0 .52.05.76.14l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 15z"
                        stroke="#fff" stroke-width="2" />
                </svg>
                <span>Settings</span>
            </a>
            <form method="post" action="{% url 'accounts:logout' %}">
                {% csrf_token %}
                <button type="submit" class="dropdown-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M16 17l5-5-5-5" stroke="#AA2C86" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M21 12H9" stroke="#AA2C86" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M12 19v2a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h5a2 2 0 012 2v2" stroke="#AA2C86"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span>Logout</span>
                </button>
            </form>
        </div>
    </div>
    <div class="cabinet-outer">
        <div class="cabinet-container dashboard-flex">
            <!-- Chap blok: Eng yaxshi natijalar -->
            <div class="profile-card">
                <div class="profile-avatar mb-2">
                    <svg width="66" height="66" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="8" r="6" stroke="#9effd0" stroke-width="2" />
                        <path d="M3 21c0-4 4.477-7 9-7s9 3 9 7" stroke="#be4b99" stroke-width="2" />
                    </svg>
                </div>
                <div class="profile-info-table">
                    <div class="profile-info-row">
                        <span class="profile-label">Username:</span>
                        <span class="profile-dots"></span>
                        <span class="profile-value">{{ user.username }}</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-label">Email:</span>
                        <span class="profile-dots"></span>
                        <span class="profile-value">{{ user.email }}</span>
                    </div>
                </div>
            </div>
            <!-- O'ng blok: User rounds table -->
            <div class="main-stats">
                <div class="table-wrapper">
                    <table class="rounds-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Round</th>
                                <th>Score</th>
                                <th>Date</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ur in userrounds %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ ur.round.title }}</td>
                                <td>{{ ur.score }}</td>
                                <td>{{ ur.started_at|date:"Y-m-d" }}</td>
                                <td>{{ ur.duration }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">You haven't participated in any rounds yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="reyting-modal" class="modal-overlay" style="display:none">
        <div class="modal-box">
            <div class="modal-header">
                <span>Top Ranking</span>
                <button class="close-modal-btn" id="close-reyting-modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" id="reyting-content">
                <!-- Ranking results will be loaded here via AJAX -->
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const openBtn = document.getElementById('open-reyting-modal');
            const closeBtn = document.getElementById('close-reyting-modal');
            const modal = document.getElementById('reyting-modal');

            if (openBtn && closeBtn && modal) {
                openBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    modal.style.display = 'block';
                    fetchReyting();
                });

                closeBtn.addEventListener('click', function () {
                    modal.style.display = 'none';
                });

                // Modal tashqarisini bosganda yopiladi
                window.addEventListener('click', function (event) {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
        });

        function fetchReyting() {
            const content = document.getElementById('reyting-content');
            content.innerHTML = '<div class="loading">Loading...</div>';
            fetch('/api/top-reyting/')
                .then(res => res.json())
                .then(data => {
                    if (!data.length) {
                        content.innerHTML = "<div style='text-align:center;color:#ccc'>No rankings yet</div>";
                        return;
                    }
                    content.innerHTML = `<ul class="reyting-list">` +
                        data.map((item, idx) => `
                    <li class="reyting-item">
                        <span class="reyting-rank">${idx + 1}</span>
                        <span class="reyting-username">${item.full_name || item.username}</span>
                        <span class="reyting-score">${item.score}</span>
                    </li>
                `).join('') +
                        `</ul>`;
                })
                .catch(() => {
                    content.innerHTML = "<div class='loading'>Error: failed to load ranking</div>";
                });
        }
        document.addEventListener('DOMContentLoaded', function () {
            const btn = document.getElementById('profile-btn');
            const dropdown = document.getElementById('profile-dropdown');

            btn.addEventListener('click', function (e) {
                e.preventDefault();
                dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
            });

            document.addEventListener('mousedown', function (e) {
                if (!dropdown.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>